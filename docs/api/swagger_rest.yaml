openapi: '3.0.2'
info:
  title: OoopsTrap Project
  version: '1.1'
  description: |
    API для управления игровыми персонажами, пользовательскими данными, играми.
    Поле `x-available-for` указывает, какие роли имеют доступ к эндпоинту:
    - Guest: неаутентифицированные пользователи
    - User: зарегистрированные игроки
    - Admin: администраторы системы
    
    ### Кастомные параметры
    - `x-max-players-for-map`: максимальное количество участников для данной опции.

servers:
  - url: 'http://localhost:8080'
    description: 'Локальный сервер для тестирования'

tags:
  - name: Auth
    description: Регистрация и авторизация пользователей
  - name: Stats
    description: Работа со статистикой игроков
  - name: Maps
    description: Получение информации о картах
  - name: Lobby
    description: Управление лобби и игровыми сессиями


components:
  securitySchemes:
    cookieAuth: # тут пока что надо подумать
      type: apiKey
      in: cookie
      name: INTERNAL_OOPS_TOKEN

  schemas:
    Error:
      type: object
      required: 
        - error
        - code
        - details
      properties:
        error:
          type: string
          example: "User not found"
          description: Тип ошибки
        code:
          type: integer
          example: 404
          description: Код ошибки
        details:
          type: string
          example: "Пользователь с id=7 не найден"
          description: Детали ошибки

    User:
      type: object
      required: 
        - id
        - username
      properties:
        id:
          type: integer
          example: 1
          description: ID пользователя
        username:
          type: string
          minLength: 1
          maxLength: 50
          example: Runner123
          description: Имя пользователя

    AuthRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: Runner123
          minLength: 1
          maxLength: 50
          description: Имя пользователя
        password:
          type: string
          format: password
          minLength: 1
          maxLength: 60
          example: MyPassword123
          description: Пароль пользователя

    RegisterRequest:
      type: object
      required:
        - username 
        - password
        - password_repeat
      properties:
        username:
          type: string
          example: Runner123
          minLength: 1
          maxLength: 50
          description: Имя пользователя
        password:
          type: string
          format: password
          minLength: 1
          maxLength: 60
          example: MyPassword123
          description: Пароль пользователя

    Map:
      type: object
      properties:
        id:
          type: integer
          example: 2
        name:
          type: string
          example: First Map
          minLength: 1
          maxLength: 100
          description: Название карты
        description:
          type: string
          example: Карта1 представляет собой пещеру и тд.
          description: Описание карты
        hp:
          type: integer
          example: 2
          minimum: 1
          description: Количество жизней у игроков на карте
        max_players:
          type: integer
          example: 10
          minimum: 3
          description: Максимальное количество игроков на карте
        picture_url:
          type: string
          example: '/design/Map1/st1.png'
          description: Изображение карты
  
    StatsEntry:
      type: object
      properties:
        map_id:
          type: integer
          example: 1
          description: ID карты
        best_time:
          type: integer
          example: 36
          description: Лучшее время в секундах
        role:
          type: string
          enum: [runner, trapmaker]
          example: runner
          description: Роль игрока на карте
  
  responses:
    400BadRequest:
      description: Некорректный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid input"
            code: 400
            details: "Введены неверные данные"
    401Unauthorized:
      description: Ошибка авторизации
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Auth token missing"
            code: 401
            details: "Пользователь не авторизован"
    403Forbidden:
      description: Нет прав доступа к этому ресурсу
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Role not authorized"
            code: 403
            details: "Нет прав доступа"
    404NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not found"
            code: 404
            details: "Информация не найдена"
    409Conflict:
      description: Конфликт данных
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "User already exists"
            code: 409
            details: "Пользователь с таким email уже зарегистрирован"

paths:

# ================= AUTH =================

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Регистрация нового пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        201:
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        400:
          $ref: '#/components/responses/400BadRequest'
        409:
          $ref: '#/components/responses/409Conflict'
          
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Авторизация пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        200:
          description: Успешная авторизация
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    $ref: '#/components/schemas/User'
        400:
          $ref: '#/components/responses/400BadRequest'
        401:
          $ref: '#/components/responses/401Unauthorized'
          
  /api/auth/logout:
    post:
      security:
        - cookieAuth: []    
      tags: [Auth]
      summary: Выход пользователя из системы
      description: Завершает текущую пользовательскую сессию
      responses:
        204:
          description: Пользователь успешно вышел
        401:
          $ref: '#/components/responses/401Unauthorized'

# ================= STATS =================

  /api/stats/{id_user}:
    get:
      tags: 
      - Stats
      summary: Получить статистику игрока по всем картам
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id_user
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Статистика игрока по всем картам
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsEntry'
              example:
                - map_id: 1
                  best_time: 36
                  role: runner
                - map_id: 2
                  best_time: 42
                  role: runner
        401:
          $ref: '#/components/responses/401Unauthorized'
        404:
          $ref: '#/components/responses/404NotFound'
  
  /api/stats/map/{id_map}:
    get:
      tags:
      - Stats
      security:
        - cookieAuth: []
      summary: Получить статистику игрока по конкретной карте
      parameters:
        - in: path
          name: id_map
          required: true
          schema:
            type: integer
          description: ID карты
      responses:
        200:
          description: Статистика игрока по указанной карте
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsEntry'
              example:
                - map_id: 1
                  best_time: 36
                  role: runner
                - map_id: 1
                  best_time: 42
                  role: trapmaker
        401:
          $ref: '#/components/responses/401Unauthorized'
        404:
          $ref: '#/components/responses/404NotFound'
  
  /api/stats/{id_lobby}:
    post:
      tags: 
      - Stats
      security:
        - cookieAuth: []
      summary: Отправить статистику по завершении игры
      parameters:
        - in: path
          name: id_lobby
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                time:
                  type: integer
                  format: float
                  example: 36
                role:
                  type: string
                  enum: 
                    - runner
                    - trapmaker
                  example: runner
      responses:
        200:
          description: Статистика успешно обновлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsEntry'
        400:
          $ref: '#/components/responses/400BadRequest'
        401:
          $ref: '#/components/responses/401Unauthorized'
        404:
          $ref: '#/components/responses/404NotFound'
        409:
          $ref: '#/components/responses/409Conflict'
          
  # ================= MAPS =================
  
  /api/maps:
    get:
      tags: [Maps]
      summary: Получить список всех карт
      responses:
        200:
          description: Список всех карт
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Map'

  /api/maps/{id_map}:
    get:
      tags: [Maps]
      summary: Получить информацию по конкретной карте
      parameters:
        - in: path
          name: id_map
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Информация по карте
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Map'
        404:
          $ref: '#/components/responses/404NotFound'

  # ================= LOBBIES =================
  
  /api/lobby/newlobby:
    post:
      tags:
        - Lobby
      summary: Создать новое лобби
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
              properties:
                ownerId:
                  type: integer
                  example: 123
                  description: ID пользователя-владельца лобби
      responses:
        201:
          description: Лобби успешно создано
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
        400:
          description: Неверный запрос
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "ownerId is required"
        404:
          description: Пользователь не найден
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/all-lobbies:
    get:
      tags:
        - Lobby
      summary: Получить список всех лобби
      responses:
        200:
          description: Список лобби успешно получен
          content:
            application/json:
              schema:
                type: object
                properties:
                  lobbies:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        owner:
                          type: string
                          example: "John Doe"
                        status:
                          type: string
                          enum: [waiting, in-progress, finished]
                          example: "waiting"
                        playerCount:
                          type: integer
                          example: 3
                  total:
                    type: integer
                    example: 5
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/{id}/delete:
    post:
      tags:
        - Lobby
      summary: Удалить лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID лобби
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
              properties:
                ownerId:
                  type: integer
                  example: 123
      responses:
        200:
          description: Лобби успешно удалено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lobby deleted successfully"
                  deletedLobbyId:
                    type: integer
                    example: 1
        400:
          description: Неверный запрос
        403:
          description: Доступ запрещен
        404:
          description: Лобби не найдено
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/{id}/settings:
    post:
      tags:
        - Lobby
      summary: Обновить настройки лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
              properties:
                ownerId:
                  type: integer
                  example: 123
                map:
                  type: integer
                  nullable: true
                  example: 5
                time:
                  type: string
                  enum: [easy, normal, hard]
                  example: "normal"
                trapper:
                  type: integer
                  nullable: true
                  example: 123
      responses:
        200:
          description: Настройки лобби успешно обновлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      map:
                        type: integer
                      time:
                        type: string
                      trapper:
                        type: integer
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
        400:
          description: Неверный запрос
        403:
          description: Доступ запрещен
        404:
          description: Лобби не найдено
        500:
          description: Внутренняя ошибка сервера

    get:
      tags:
        - Lobby
      summary: Получить настройки лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Настройки лобби успешно получены
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      map:
                        type: integer
                      time:
                        type: string
                      trapper:
                        type: integer
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
                      createdAt:
                        type: string
                        format: date-time
        400:
          description: Неверный запрос
        404:
          description: Лобби не найдено
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/{id}/status:
    post:
      tags:
        - Lobby
      summary: Изменить статус лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
                - newStatus
              properties:
                ownerId:
                  type: integer
                  example: 123
                newStatus:
                  type: string
                  enum: [waiting, in-progress, finished]
                  example: "in-progress"
      responses:
        200:
          description: Статус лобби успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobby:
                    type: object
        400:
          description: Неверный запрос
        403:
          description: Доступ запрещен
        404:
          description: Лобби не найдено
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/{id}/join:
    post:
      tags:
        - Lobby
      summary: Добавить пользователя в лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: integer
                  example: 123
      responses:
        200:
          description: Пользователь успешно добавлен в лобби
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User joined lobby successfully"
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      status:
                        type: string
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
        400:
          description: Неверный запрос
        404:
          description: Лобби или пользователь не найден
        409:
          description: Пользователь уже в другом лобби
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/{id}/leave:
    post:
      tags:
        - Lobby
      summary: Удалить пользователя из лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: integer
                  example: 123
      responses:
        200:
          description: Пользователь успешно удален из лобби
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobbyDeleted:
                    type: boolean
                  deletedLobbyId:
                    type: integer
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
                      trapper:
                        type: integer
        400:
          description: Неверный запрос
        404:
          description: Лобби или пользователь не найден
        500:
          description: Внутренняя ошибка сервера


  /users/{id}:
    get:
      tags:
        - Users
      summary: Получить имя пользователя по ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Имя пользователя успешно получено
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
        404:
          description: Пользователь не найден
        500:
          description: Внутренняя ошибка сервера