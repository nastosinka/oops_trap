openapi: '3.0.2'
info:
  title: OoopsTrap Project
  version: '1.1'
  description: |
    API для управления игровыми персонажами, пользовательскими данными, играми.
    Поле `x-available-for` указывает, какие роли имеют доступ к эндпоинту:
    - Guest: неаутентифицированные пользователи
    - User: зарегистрированные игроки
    - Admin: администраторы системы
    
    ### Кастомные параметры
    - `x-max-players-for-map`: максимальное количество участников для данной опции.

servers:
  - url: 'http://localhost:8080'
    description: 'Локальный сервер для тестирования'

tags:
  - name: Auth
    description: Регистрация и авторизация пользователей
  - name: Stats
    description: Работа со статистикой игроков
  - name: Maps
    description: Получение информации о картах
  - name: Lobby
    description: Управление лобби и игровыми сессиями


components:
  securitySchemes:
    cookieAuth: # тут пока что надо подумать
      type: apiKey
      in: cookie
      name: INTERNAL_OOPS_TOKEN

  schemas:
    Error:
      type: object
      required: 
        - error
        - code
        - details
      properties:
        error:
          type: string
          example: "User not found"
          description: Тип ошибки
        code:
          type: integer
          example: 404
          description: Код ошибки
        details:
          type: string
          example: "Пользователь с id=7 не найден"
          description: Детали ошибки

    User:
      type: object
      required: 
        - id
        - username
      properties:
        id:
          type: integer
          example: 1
          description: ID пользователя
        username:
          type: string
          minLength: 1
          maxLength: 50
          example: Runner123
          description: Имя пользователя

    AuthRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: Runner123
          minLength: 1
          maxLength: 50
          description: Имя пользователя
        password:
          type: string
          format: password
          minLength: 1
          maxLength: 60
          example: MyPassword123
          description: Пароль пользователя

    RegisterRequest:
      type: object
      required:
        - username 
        - password
      properties:
        username:
          type: string
          example: Runner123
          minLength: 1
          maxLength: 50
          description: Имя пользователя
        password:
          type: string
          format: password
          minLength: 1
          maxLength: 60
          example: MyPassword123
          description: Пароль пользователя

    Map:
      type: object
      properties:
        id:
          type: integer
          example: 2
        name:
          type: string
          example: First Map
          minLength: 1
          maxLength: 100
          description: Название карты
        description:
          type: string
          example: Карта1 представляет собой пещеру и тд.
          description: Описание карты
        hp:
          type: integer
          example: 2
          minimum: 1
          description: Количество жизней у игроков на карте
        time_1:
          type: integer
          example: 60
          description: Время-1 (сек)
        time_2:
          type: integer
          example: 80
          description: Время-2 (сек)
        time_3:
          type: integer
          example: 100
          description: Время-3 (сек)
        max_players:
          type: integer
          example: 10
          minimum: 3
          description: Максимальное количество игроков на карте
        picture_url:
          type: string
          example: '/design/Map1/st1.png'
          description: Изображение карты
  
    StatsEntry:
      type: object
      properties:
        map_id:
          type: integer
          example: 1
          description: ID карты
        best_time:
          type: integer
          example: 36
          description: Лучшее время в секундах
        role:
          type: string
          enum: [runner, trapmaker]
          example: runner
          description: Роль игрока на карте
  
  responses:
    400BadRequest:
      description: Некорректный запрос
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid input"
            code: 400
            details: "Введены неверные данные"
    401Unauthorized:
      description: Ошибка авторизации
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Auth token missing"
            code: 401
            details: "Пользователь не авторизован"
    403Forbidden:
      description: Нет прав доступа к этому ресурсу
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Role not authorized"
            code: 403
            details: "Нет прав доступа"
    404NotFound:
      description: Ресурс не найден
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not found"
            code: 404
            details: "Информация не найдена"
    409Conflict:
      description: Конфликт данных
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "User already exists"
            code: 409
            details: "Пользователь с таким email уже зарегистрирован"
    500ServerError:
      description: Ошибка сервера
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Server error"
            code: 500
            details: "Ошибка сервера"

paths:

# ================= AUTH =================

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Регистрация нового пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        201:
          description: Пользователь успешно зарегистрирован
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        400:
          description: Некорректные данные
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Пароль должен содержать минимум 6 символов"
                  code: 400
        409:
          description: Пользователь с таким именем уже существует
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Пользователь с таким именем уже существует"
                  code: 409
        500:
          description: Ошибка сервера при регистрации
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Ошибка сервера при регистрации"
                  code: 500       
        
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Авторизация пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthRequest'
      responses:
        200:
          description: Успешная авторизация
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        400:
          description: Имя пользователя или пароль не указаны
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Введите имя пользователя и пароль"
                  code: 400
        401:
          description: Неверное имя пользователя или пароль
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Неверное имя пользователя или пароль"
                  code: 401
        500:
          description: Ошибка сервера при авторизации
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                example:
                  error: "Ошибка сервера при авторизации"
                  code: 500                  
          
  /api/auth/users:
    get:
      tags: [Auth]
      summary: Получить всех пользователей
      responses:
        200:
          description: Список всех зарегистрированных игроков
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        name:
                          type: string
                          example: user1
                  total:
                    type: integer
                    example: 3

# ================= STATS =================

  /api/stats/{id_user}:
    get:
      tags: 
      - Stats
      summary: Получить статистику игрока по всем картам
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id_user
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Статистика игрока по всем картам
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsEntry'
              example:
                - map_id: 1
                  best_time: 36
                  role: runner
                - map_id: 2
                  best_time: 42
                  role: runner
        401:
          $ref: '#/components/responses/401Unauthorized'
        404:
          $ref: '#/components/responses/404NotFound'
  
  /api/stats/{id_lobby}:
    post:
      tags: 
      - Stats
      security:
        - cookieAuth: []
      summary: Отправить статистику по завершении игры
      parameters:
        - in: path
          name: id_lobby
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                time:
                  type: integer
                  format: float
                  example: 36
                role:
                  type: string
                  enum: 
                    - runner
                    - trapmaker
                  example: runner
      responses:
        200:
          description: Статистика успешно обновлена
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatsEntry'
        400:
          $ref: '#/components/responses/400BadRequest'
        401:
          $ref: '#/components/responses/401Unauthorized'
        404:
          $ref: '#/components/responses/404NotFound'
        409:
          $ref: '#/components/responses/409Conflict'
          
  # ================= MAPS =================
  
  /api/maps:
    get:
      tags: [Maps]
      summary: Получить список всех карт
      responses:
        200:
          description: Список всех карт
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Map'
        404:
          $ref: '#/components/responses/404NotFound'
        500:
          $ref: '#/components/responses/500ServerError'

  /api/maps/{id_map}:
    get:
      tags: [Maps]
      summary: Получить информацию по конкретной карте
      parameters:
        - in: path
          name: id_map
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Информация по карте
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Map'
        404:
          $ref: '#/components/responses/404NotFound'
        500:
          $ref: '#/components/responses/500ServerError'

  # ================= LOBBIES =================
  
  /api/lobby/newlobby:
    post:
      tags:
        - Lobby
      summary: Создать новое лобби
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                id:
                  type: integer
                  example: 3
                  description: ID созданного лобби
      responses:
        201:
          description: Лобби успешно создано
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
        400:
          description: Неверный запрос
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "ownerId is required"
        404:
          description: Пользователь не найден
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "User not found"
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/all-lobbies:
    get:
      tags:
        - Lobby
      summary: Получить список всех лобби
      responses:
        200:
          description: Список лобби успешно получен
          content:
            application/json:
              schema:
                type: object
                properties:
                  lobbies:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        owner:
                          type: string
                          example: "John Doe"
                        status:
                          type: string
                          enum: [waiting, in-progress, finished]
                          example: "waiting"
                        playerCount:
                          type: integer
                          example: 3
                  total:
                    type: integer
                    example: 5
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/lobbies/{id}/delete:
    post:
      tags:
        - Lobby
      summary: Удалить лобби
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
          description: ID лобби
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
              properties:
                ownerId:
                  type: integer
                  example: 123
      responses:
        200:
          description: Лобби успешно удалено
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Lobby deleted successfully"
                  deletedLobbyId:
                    type: integer
                    example: 1
        400:
          description: Неверный запрос
        403:
          description: Доступ запрещен
        404:
          description: Лобби не найдено
        500:
          description: Внутренняя ошибка сервера

  /api/lobby/lobbies/{id}/settings:
    post:
      tags:
        - Lobby
      summary: Обновить настройки лобби
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID лобби
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ownerId
              properties:
                map:
                  type: integer
                  nullable: true
                  example: 5
                time:
                  type: string
                  enum: [easy, normal, hard]
                  example: "normal"
                trapper:
                  type: integer
                  nullable: true
                  example: 123
      responses:
        200:
          description: Настройки лобби успешно обновлены
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      map:
                        type: integer
                      time:
                        type: string
                      trapper:
                        type: integer
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
        400:
          description: Ошибка валидации или неверные данные
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidLobbyId:
                  summary: Неверный ID лобби
                  value:
                    error: "Invalid lobby ID"
                validationFailed:
                  summary: Ошибка валидации настроек
                  value:
                    error: "Validation failed"
                    details:
                      - "Invalid map ID: 99. Valid map IDs: 1, 2, 3"
                      - "Invalid time: insane. Valid options: easy, normal, hard"
        403:
          description: Пользователь не является владельцем лобби
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Access denied. Only the lobby owner can change lobby settings"
        404:
          description: Лобби не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
        500:
          description: Ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"
    get:
      tags:
        - Lobby
      summary: Получить настройки лобби
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Настройки лобби успешно получены
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      map:
                        type: integer
                      time:
                        type: string
                      trapper:
                        type: integer
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
                      createdAt:
                        type: string
                        format: date-time
        400:
          description: Неверный ID лобби
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Invalid lobby ID"
  
        404:
          description: Лобби не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
  
        500:
          description: Ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"

  /api/lobby/lobbies/{id}/status:
    post:
      tags:
        - Lobby
      summary: Изменить статус лобби
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          description: ID лобби
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - newStatus
              properties:
                newStatus:
                  type: string
                  description: Новый статус лобби
                  enum: [waiting, in-progress, finished]
                  example: "in-progress"
      responses:
        200:
          description: Статус лобби успешно изменен
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobby:
                    type: object
        400:
          description: Некорректные данные запроса
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Cannot change status to in-progress"
                details:
                  - "Cannot start game: at least 2 players required"
                  - "Trapper is not assigned"
        403:
          description: Доступ запрещён (только владелец лобби может менять статус)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Access denied. Only the lobby owner can change lobby status"
        404:
          description: Лобби не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"
  
    get:
      tags: [Lobby]
      summary: Получить статус лобби
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID лобби
      responses:
        200:
          description: Статус найденного лобби
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      status:
                        type: string
                        example: finished
        400:
          description: Неверный формат ID
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Invalid lobby ID
        404:
          description: Лобби не найдено
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Lobby not found
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  error:
                    type: string
                    example: Internal server error


  /api/lobby/lobbies/{id}/join:
    post:
      tags:
        - Lobby
      summary: Добавить пользователя в лобби
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Пользователь успешно добавлен в лобби
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "User joined lobby successfully"
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      status:
                        type: string
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
        400:
          description: Ошибка запроса (пользователь уже в другом лобби, в этом лобби или игра уже началась)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Cannot join lobby - game already started"

        404:
          description: Лобби или пользователь не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
  
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"

  /api/lobby/lobbies/{id}/leave:
    post:
      tags:
        - Lobby
      summary: Удалить пользователя из лобби
      security:
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Пользователь успешно удален из лобби
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  lobbyDeleted:
                    type: boolean
                  deletedLobbyId:
                    type: integer
                  lobby:
                    type: object
                    properties:
                      id:
                        type: integer
                      ownerId:
                        type: integer
                      status:
                        type: string
                      players:
                        type: array
                        items:
                          $ref: '#/components/schemas/User'
                      playerCount:
                        type: integer
                      trapper:
                        type: integer
        400:
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Cannot leave lobby"
        404:
          description: Лобби или пользователь не найден
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"

  /api/lobby/lobbies/{id}/users:
    get:
      tags: [Lobby]
      summary: Получить список игроков в лобби
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID лобби
      responses:
        200:
          description: Информация о лобби и его игроках
          content:
            application/json:
              schema:
                type: object
                properties:
                  lobbyId:
                    type: integer
                    example: 1
                  playerCount:
                    type: integer
                    example: 2
                  players:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 3
                        name:
                          type: string
                          example: user1
        400:
          description: Некорректный запрос
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Cannot get users from this lobby"
        404:
          description: Лобби не найдено
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Lobby not found"
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Internal server error"

  /api/lobby/games:
    get:
      tags: [Lobby]
      summary: Получить список активных игр
      responses:
        200:
          description: Список активных игр
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    example: 1
                  games:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 1
                        lobbyId:
                          type: integer
                          example: 1
                        map:
                          type: integer
                          example: 2
                        trapper:
                          type: integer
                          example: 2
                        time:
                          type: string
                          example: normal
                          description: Режим длительности игры
                        playerCount:
                          type: integer
                          example: 2
                        players:
                          type: array
                          items:
                            type: object
                            properties:
                              id:
                                type: integer
                                example: 3
                              name:
                                type: string
                                example: user1
                        status:
                          type: string
                          example: in-progress
                          description: Статус игры
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Internal server error

  /users/{id}:
    get:
      tags:
        - Users
      summary: Получить имя пользователя по ID
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Имя пользователя успешно получено
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string
        404:
          description: Пользователь не найден
        500:
          description: Внутренняя ошибка сервера
          
  /api/ws/sessions:
    get:
      tags: [WebSocket]
      summary: Получить список активных игровых WebSocket-сессий
      security:
        - cookieAuth: []
      responses:
        200:
          description: Список активных WebSocket-сессий
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: integer
                    example: [1]
        500:
          description: Внутренняя ошибка сервера
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Internal server error
  /api/ws/game/{id}:
    get:
      tags: [WebSocket]
      summary: Получить WebSocket URL для игровой сессии
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID игровой сессии (gameId)
      responses:
        200:
          description: Сессия найдена — WebSocket URL доступен
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: true
                  gameId:
                    type: integer
                    example: 1
                  wsUrl:
                    type: string
                    example: "/ws/game/1"
        404:
          description: Сессия не найдена
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: "Game session 2 not found"
